<?php
/**
 * BYTEGUESS – STEP 6 FINAL GENERATION
 * Rebuilds AI context from byteguess_user_input
 * Generates:
 *  - Card group
 *  - Cards
 *  - Hypothesis options
 *  - Answer key
 */

ini_set('display_errors', 0);
ini_set('max_execution_time', 300);
ini_set('memory_limit', '512M');
error_reporting(E_ALL & ~E_NOTICE & ~E_WARNING);

session_start();
header("Content-Type: application/json");

require "../include/dataconnect.php";
require "../config.php";
require "../openai_call.php";

/* =========================================================
   SESSION + INPUT VALIDATION
========================================================= */

$team_id = $_SESSION['team_id'] ?? 0;

$input = json_decode(file_get_contents("php://input"), true);
$ui_id = intval($input['ui_id'] ?? 0);

if (!$team_id || !$ui_id) {
    echo json_encode(["status"=>"error","message"=>"Invalid request"]);
    exit;
}

/* =========================================================
   LOAD USER INPUT (DRAFT)
========================================================= */

$stmt = $conn->prepare("
    SELECT *
    FROM byteguess_user_input
    WHERE ui_id = ? AND ui_team_pkid = ?
");
$stmt->bind_param("ii", $ui_id, $team_id);
$stmt->execute();
$ui = $stmt->get_result()->fetch_assoc();

if (!$ui) {
    echo json_encode(["status"=>"error","message"=>"Draft not found"]);
    exit;
}

/* =========================================================
   CREATE CARD GROUP (GAME)
========================================================= */
$stmt = $conn->prepare("
    INSERT INTO card_group
    (cg_name, cg_description, cg_max, byteguess_pkid, cg_status)
    VALUES (?, ?, ?, ?, 1)
");
$stmt->bind_param(
    "ssii",
    $ui['ui_game_name'],
    $ui['ui_game_description'], // from STEP-1 org description
    $ui['ui_cards_drawn'],
    $team_id
);
$stmt->execute();


$cg_id = $stmt->insert_id;

/* =========================================================
   AI MEMORY (REBUILT SEQUENTIALLY)
========================================================= */

$messages = [];

/* ---------------- STEP 2 PROMPT ---------------- */

$prompt2 = "
You are an instructional content designer assisting in the creation of a randomized learning card game.

Game Structure
The game consists of {$ui['ui_total_cards']} information cards.
Each playthrough opens {$ui['ui_cards_drawn']} cards.

Rules
• Each card shows partial clues
• The conclusion must NOT appear on a single card
• Insight must emerge only through synthesis

Do not generate content yet.
Acknowledge understanding only.
";

$messages[] = ["role"=>"user","content"=>$prompt2];
$response2 = callOpenAI($messages);
$messages[] = ["role"=>"assistant","content"=>$response2];

/* ---------------- STEP 3 PROMPT ---------------- */

$prompt3 = "
Create a fictitious company scenario.

Training Topic: {$ui['ui_training_topic']}
Industry: {$ui['ui_industry']}
Objective: {$ui['ui_objective']}

Participants should identify a hidden hypothesis related to:
{$ui['ui_hypothesis']}

Requirements:
• Fictitious company
• 7–8 sentences
• Realistic business tone
• No training language
";

$messages[] = ["role"=>"user","content"=>$prompt3];
$response3 = callOpenAI($messages);
$messages[] = ["role"=>"assistant","content"=>$response3];

/* ---------------- STEP 4 PROMPT (CARDS) ---------------- */

$prompt4 = "
Using the agreed structure and company context, create exactly {$ui['ui_total_cards']} cards.

Each card:
• May include: {$ui['ui_card_structure']}
• 4-5 statements
• Indirect language
• No conclusions

Format STRICTLY:
**Card 1: Title**
Paragraph
";

$messages[] = ["role"=>"user","content"=>$prompt4];
$cardsRaw = callOpenAI($messages);
$messages[] = ["role"=>"assistant","content"=>$cardsRaw];

/* =========================================================
   PARSE + INSERT CARDS
========================================================= */

$blocks = preg_split('/\*\*Card\s+\d+:/', $cardsRaw);
array_shift($blocks);

if (count($blocks) < $ui['ui_total_cards']) {
    echo json_encode([
        "status"=>"error",
        "message"=>"AI card generation failed",
        "raw"=>$cardsRaw
    ]);
    exit;
}

$stmt = $conn->prepare("
    INSERT INTO card_unit
    (cu_card_group_pkid, cu_sequence, cu_name, cu_image, cu_description, cu_status)
    VALUES (?, ?, ?, 'cu_image.jpg', ?, 1)
");

$seq = 1;
foreach ($blocks as $block) {
    $lines = preg_split("/\R/", trim($block));
    $title = trim(str_replace("**","",array_shift($lines)));
    $text  = trim(implode("\n",$lines));

    if ($title && $text) {
        $stmt->bind_param("iiss", $cg_id, $seq, $title, $text);
        $stmt->execute();
        $seq++;
    }
}

/* ---------------- STEP 5 PROMPT (OPTIONS) ---------------- */

$opts = json_decode($ui['ui_options'], true);

$prompt5 = "
Using the generated cards, create four hypothesis options.

Mix:
• {$opts['full']} fully correct
• {$opts['partial']} partially correct
• {$opts['wrong']} incorrect

Rules:
• Short title (≤4 words)
• 2–3 statements each
• No labels

Format STRICTLY:
**Option X: Title**
Paragraph
";

$messages[] = ["role"=>"user","content"=>$prompt5];
$optionsRaw = callOpenAI($messages);

/* Parse options */
preg_match_all(
    '/\*\*Option\s+(\d+):\s*(.*?)\*\*\s*(.*?)(?=\n\*\*Option|\z)/s',
    $optionsRaw,
    $matches,
    PREG_SET_ORDER
);

if (count($matches) !== 4) {
    echo json_encode([
        "status"=>"error",
        "message"=>"Option parsing failed",
        "raw"=>$optionsRaw
    ]);
    exit;
}

$answers = [];
$order = 1;
foreach ($matches as $m) {
    $answers[] = [
        "order"=>$order++,
        "title"=>trim($m[2]),
        "answer"=>trim($m[3])
    ];
}

$jsonAnswers = json_encode($answers, JSON_UNESCAPED_UNICODE);

$stmt = $conn->prepare("
    UPDATE card_group
    SET cg_answer = ?
    WHERE cg_id = ?
");
$stmt->bind_param("si", $jsonAnswers, $cg_id);
$stmt->execute();

/* ---------------- STEP 6 PROMPT (ANSWER KEY) ---------------- */

$prompt6 = "
Generate a participant-facing answer key.

Explain:
• Why the correct option is strongest
• How card signals connect
• What partial options miss

Tone:
• Constructive
• Learning-oriented
";

$messages[] = ["role"=>"user","content"=>$prompt6];
$answerKey = callOpenAI($messages);

$stmt = $conn->prepare("
    UPDATE card_group
    SET cg_result = ?
    WHERE cg_id = ?
");
$stmt->bind_param("si", $answerKey, $cg_id);
$stmt->execute();

/* =========================================================
   FINALIZE
========================================================= */

$stmt = $conn->prepare("
    UPDATE byteguess_user_input
    SET ui_cur_step = 6
    WHERE ui_id = ?
");
$stmt->bind_param("i", $ui_id);
$stmt->execute();

echo json_encode([
    "status"=>"success",
    "cg_id"=>$cg_id
]);
